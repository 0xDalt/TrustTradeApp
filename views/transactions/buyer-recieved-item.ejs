<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel='stylesheet' href='style.css' />
  <title>
    <%= title %>
  </title>
</head>


<body>
  <!--NAVBAR-->
  <%- include ../partials/nav.ejs %>
  <%- include ../partials/header.ejs %>
    <div class="form wrapper">
      <form name="Form" action="" method="get">
          <div class="container my-5">
            <h1>
              <%= title %>
            </h1>
            <h4><%= struct.EscrowContract %></h4>
            <p><%= struct.description %></p>
          </div>
      </form>
    </div>
          <!--  GAP
-->
          <div class="wrapper">
            <form id="transForm"  action="/trans/<%= contractAddress %>/buyer-recieved-item" method="POST"> 
              <input name="ethAddress" type="hidden" />
              <div id="ifIsBuyer"></div>

              <script>
                /*

                https://docs.metamask.io/guide/ethereum-provider.html#methods
                https://docs.metamask.io/guide/rpc-api.html#ethereum-json-rpc-methods
                https://eth.wiki/json-rpc/API#eth_accounts

                */

                (async ()=>{
                  if (typeof window.ethereum === 'undefined') {
                    return console.log('MetaMask is not installed!');
                  }

                  let accounts = await ethereum.request({ method: 'eth_accounts' });
                  console.log(accounts);
                  var inputNode = document.querySelector("input[name=ethAddress]")
                  inputNode.value = accounts[0];

                  const buyerAddress = "<%= struct.buyer %>";
                  var buyerNode = document.querySelector("#ifIsBuyer");

                  console.log(
                    "account test:",
                    accounts[0],
                    buyerAddress,
                    accounts[0].toLowerCase() === buyerAddress.toLowerCase()
                  );
                  if(
                    accounts[0].toLowerCase() === buyerAddress.toLowerCase()
                  ){
                    buyerNode.innerHTML = `
                      <h3>Buyer Has Recieved Item</h3>
                      <button type="submit">Submit</button>
                    `
                  } else {
                    buyerNode.innerHTML = `
                      <h3>You are not the buyer</h3>
                    `
                  }
                })()
              </script>
            </form>

            <script type="text/javascript" >
              var form = document.querySelector("#transForm");
              console.log("create trans:", form)
              form.addEventListener("submit", async (e)=>{
                e.preventDefault()
                console.log("createEscrow:", window.App.contracts.EscrowContainerInstance.methods);

                const ethAddress = document.querySelector("input[name=ethAddress]").value;

                var escrow = await window.App.contracts.EscrowContainerInstance.methods.buyerRecieveItem().send(
                  {
                    from: ethAddress,
                  }
                );
                console.log(escrow);
                window.location = "/trans/<%= ESCROW_CONTRACT_ADDRESS %>";

              })    
            </script>

          </div>
         <div>
          <%- include ../partials/footer.ejs %>
         </div>
</body>


<script>
  function openNav() {
    document.getElementById("mySidenav").style.width = "250px";
  }

  function closeNav() {
    document.getElementById("mySidenav").style.width = "0";
  }
</script>
</body>

</html>